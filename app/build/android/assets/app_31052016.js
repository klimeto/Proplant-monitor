function eventListenerTiGeolocation(e){if(e.error)return void divider(e.error);divider("eventListenerTiGeolocation"),console.log(e);e.coords.longitude,e.coords.latitude,e.coords.altitude,e.coords.heading,e.coords.accuracy,e.coords.speed,e.coords.timestamp,e.coords.altitudeAccuracy}function usleep(e){for(var t=(new Date).getTime();new Date<t+e/1e3;);return!0}function formatString(e,t){return e.replace(/%(\d+)/g,function(e,a){return t[--a]})}function getElementById(e,t){var a=e.templates.template.childTemplates[1].tiProxy.children;for(var o in a)if(Ti.API.info("Number of children: "+a.length),Ti.API.info(a[o].id),a[o].id==t)return a[o];return Ti.API.warn("No children, its single: "),console.log(JSON.stringify(e)),null}function dateTime(e,t){if(void 0===t)var a=new Date;else var a=new Date(t);var o=a.getHours(),i=a.getMinutes(),n=a.getSeconds(),r=a.getMonth()+1,l=a.getDate(),d=a.getFullYear();r<10&&(r="0"+r),l<10&&(l="0"+l),o<10&&(o="0"+o),i<10&&(i="0"+i),n<10&&(n="0"+n);var s=d+"-"+r+"-"+l+" "+o+":"+i;return void 0!==e&&(s+=":"+n),s}function divider(e){e=void 0===e?"######################":" "+e+" ",Ti.API.warn("#"),Ti.API.warn("## "+dateTime(!0)+" #################################"+e+"##"),Ti.API.warn("#")}function clearObservationsFromMainWindow(){var e=MainWindowScrollView.children,t=e.length,a=!1;for(divider(),i=0;i<t;i++)e[i].html==labelObservationsNewText&&(a=!0),a&&MainWindowScrollView.remove(e[i])}function drawObservationsToMainWindow(){obsColor="#00A20B",labelObservationsNew=new Label(labelObservationsNewText),observationsTop=240+observationsInitialOffset,labelObservationsNew.top=observationsTop,labelObservationsNew.width="80%",labelObservationsNew.left="15%",labelObservationsNew.textAlign=Ti.UI.TEXT_ALIGNMENT_LEFT,labelObservationsNew.font={fontSize:24},MainWindowScrollView.add(labelObservationsNew),labelObservationsNewBox=new Label,labelObservationsNewBox.top=observationsTop+16,labelObservationsNewBox.left="5%",labelObservationsNewBox.width=24,labelObservationsNewBox.height=24,labelObservationsNewBox.color=obsColor,labelObservationsNewBox.borderRadius=5,labelObservationsNewBox.backgroundColor=obsColor,MainWindowScrollView.add(labelObservationsNewBox),observationObjects=[],observationsTop+=55;var e=Ti.Database.open(menoDatabazy),t=e.execute("SELECT * from annotations WHERE gmlID=0 AND uid='"+myNickname+"' ORDER BY id DESC"),a=noDataTextNew;selectedObservationsToBoxes(t,a,"new"),e.close(),obsColor="#FFD600",labelObservationsUpdated=new Label(labelObservationsUpdText),labelObservationsUpdated.top=observationsTop,labelObservationsUpdated.left="15%",labelObservationsUpdated.width="80%",labelObservationsUpdated.textAlign=Ti.UI.TEXT_ALIGNMENT_LEFT,labelObservationsUpdated.font={fontSize:24},MainWindowScrollView.add(labelObservationsUpdated),labelObservationsUpdBox=new Label,labelObservationsUpdBox.top=observationsTop+16,labelObservationsUpdBox.left="5%",labelObservationsUpdBox.width=24,labelObservationsUpdBox.height=24,labelObservationsUpdBox.color=obsColor,labelObservationsUpdBox.borderRadius=5,labelObservationsUpdBox.backgroundColor=obsColor,MainWindowScrollView.add(labelObservationsUpdBox),observationsTop+=55;var e=Ti.Database.open(menoDatabazy),t=e.execute("SELECT * from annotations WHERE mark_for_push=1 AND uid='"+myNickname+"' ORDER BY id DESC"),a=noDataTextUpd;selectedObservationsToBoxes(t,a,"upd"),e.close(),obsColor="#FF0000",labelObservationsRemoved=new Label(labelObservationsRemText),labelObservationsRemoved.top=observationsTop,labelObservationsRemoved.left="15%",labelObservationsRemoved.width="80%",labelObservationsRemoved.textAlign=Ti.UI.TEXT_ALIGNMENT_LEFT,labelObservationsRemoved.font={fontSize:24},MainWindowScrollView.add(labelObservationsRemoved),labelObservationsDelBox=new Label,labelObservationsDelBox.top=observationsTop+16,labelObservationsDelBox.left="5%",labelObservationsDelBox.width=24,labelObservationsDelBox.height=24,labelObservationsDelBox.color=obsColor,labelObservationsDelBox.borderRadius=5,labelObservationsDelBox.backgroundColor=obsColor,MainWindowScrollView.add(labelObservationsDelBox),observationsTop+=55;var e=Ti.Database.open(menoDatabazy),t=e.execute("SELECT * from annotations WHERE mark_for_del=1 AND uid='"+myNickname+"' ORDER BY id DESC"),a=noDataTextRem;selectedObservationsToBoxes(t,a,"del"),e.close()}function redrawObservations(){clearObservationsFromMainWindow();var e=Ti.Database.open(menoDatabazy),t=e.execute("SELECT * from annotations WHERE uid='"+myNickname+"' AND (gmlID=0 OR mark_for_push=1 OR mark_for_del=1) ");e.close(),t.rowCount&&drawPushWindow(),drawObservationsToMainWindow(),MainWindowScrollView.scrollTo(0,MainWindowScrollTopLast),activityIndicator.hide()}function redrawObservationsToMainWindow(){redrawObservations()}function pushOneImage(){divider("pushOneImage - START OF FUNCTION ");var e=Ti.Database.open(menoDatabazy),t=e.execute("SELECT * from annotations WHERE uid='"+myNickname+"' AND imageDeviceId='"+myDeviceId+"' AND imagePathLocal!='' AND imagePathLocal!='null' AND (imagePathServer='' OR imagePathServer='null') LIMIT 1"),a=e.execute("SELECT * from annotations WHERE uid='"+myNickname+"' AND imageDeviceId='"+myDeviceId+"' AND imagePathLocal!='' AND imagePathLocal!='null' AND (imagePathServer='' OR imagePathServer='null')");if(e.close(),t.rowCount){toRefreshMainWindow++,divider("pushOneImage - if(select.rowCount) is TRUE - starting to push image");var o="http://bolegweb.geof.unizg.hr/proplant/api/push_photo.php",i=dateTime(!0).replace(/\s+/g,"_").replace(/:/g,"-"),n=Ti.Filesystem.getFile(t.fieldByName("imagePathLocal")),r=n.read(),l=!0;progressIndicator.value=0,progressIndicator.message="Uploading "+a.rowCount+" images",1==a.rowCount&&(progressIndicator.message="Uploading 1 image"),progressIndicator.show();var d=Titanium.Network.createHTTPClient(),s="";d.onsendstream=function(e){l=!1,progressIndicator.value=Math.ceil(100*e.progress),s!=progressIndicator.value&&(s=progressIndicator.value,Ti.API.info("ONSENDSTREAM - PROGRESS: "+Math.ceil(100*e.progress)+"%"))},d.onreadystatechange=function(e){if(4==d.readyState&&200==d.status){progressIndicator.hide();var o=Ti.Database.open(menoDatabazy),i=myNickname.split("#");i=i[0],o.execute("DELETE FROM annotations WHERE id="+t.fieldByName("id")),o.close(),divider("DELETE FROM annotations WHERE id="+t.fieldByName("id")),1==a.rowCount&&(Ti.UI.createAlertDialog({title:"Upload was done",message:"You need to re-download server data to see your changes"}).show(),1==toRefreshMainWindow&&(toRefreshMainWindow=0,redrawObservations(),pushRemoveIfNeeded()),toRefreshMainWindow>1&&toRefreshMainWindow--),d.onreadystatechange=null,console.log(e.source.responseData.text),divider("ROW 3140 - triggering another photo......."),pushOneImage()}},d.onload=function(e){l||divider("XHR ONLOAD 3146")},d.open("POST",o),d.send({fileContent:r,myNickname:myNickname,myFilename:i,nativePath:t.fieldByName("imagePathLocal")})}}function clickedOnUnchecked(){MainWindowScrollView.remove(iconRadioUnchecked),MainWindowScrollView.add(iconRadioChecked),termsOfUse=1}function clickedOnChecked(){MainWindowScrollView.remove(iconRadioChecked),MainWindowScrollView.add(iconRadioUnchecked),termsOfUse=0}function buttonUserClick(){new AlertInput("Enter your nickname#pin or enter nickname only to create new user account: ",myNickname,function(e){0==e.index&&changeUser(e.source.androidView.value)})}function buttonServerClick(){new AlertInput("You can set server URL here: ",endpointURL,function(e){0==e.index&&changeServer(e.source.androidView.value)})}function buttonRetrieveDatasetsFunc(){if(isOnline=Titanium.Network.getOnline()){var e=endpointURL+"?service=WFS&version=2.0.0&request=GetCapabilities",t=Ti.Network.createHTTPClient();try{t.onload=function(){var e=this.responseXML.documentElement,t=e.getElementsByTagName("FeatureType");databuttonRetrieveDatasets=[];var a=Ti.Database.open(menoDatabazy);a.execute("DELETE FROM featureTypes WHERE endpointURL='"+endpointURL+"' ");for(var o=0;o<t.length;o++){var i=t.item(o).getElementsByTagName("Name").item(0).textContent;databuttonRetrieveDatasets[o]=i,a.execute("INSERT INTO featureTypes (endpointURL, featureType) VALUES ('"+endpointURL+"', '"+i+"')")}buttonSelectDataset(),a.close(),featureTYPE="proplant:obs_all"},t.onerror=function(e){alert("Whoops...something is wrong check URL you entered. Error details: "+e.error)},t.open("GET",e),t.send()}catch(e){alert(e)}}else{databuttonRetrieveDatasetsLocal=[];var a=Ti.Database.open(menoDatabazy),o=a.execute("SELECT * from featureTypes WHERE endpointURL='"+endpointURL+"' ORDER BY featureType");a.close(),Ti.API.info("GEO APP: Loading endpointURLs from local db");for(var i=0;o.isValidRow();)databuttonRetrieveDatasetsLocal[i]=o.fieldByName("featureType"),o.next(),i++;buttonSelectDataset(),featureTYPE="proplant:obs_all"}}function buttonSelectDataset(){var e={destructive:1,cancel:2,title:"Choose observation type:"};isAndroid&&(e.selectedIndex=0);var t=Titanium.UI.createOptionDialog(e);t.title="Select dataset:",isOnline=Titanium.Network.getOnline(),isOnline?(t.options=databuttonRetrieveDatasets,t.destructive=0,t.cancel=3,isAndroid&&(t.androidView=null,t.buttonNames=["Cancel"]),t.show()):databuttonRetrieveDatasetsLocal.length<1?alert("No local data found! No internet connection found! Cannot load data..."):(t.options=databuttonRetrieveDatasetsLocal,t.destructive=0,t.cancel=3,isAndroid&&(t.androidView=null,t.buttonNames=["Cancel"]),t.show()),readdEventListener(t,"click",function(e){e.button?activityIndicator.hide():(isOnline=Titanium.Network.getOnline(),featureTYPE=isOnline?databuttonRetrieveDatasets[e.index]:databuttonRetrieveDatasetsLocal[e.index],buttonAddToMapFunc())})}function buttonAddToMapFunc(){var e=endpointURL+"?service=WFS&version=2.0.0&request=GetFeature&typeName="+featureTYPE+"&srsName=EPSG:4326&outputFormat=application/json";if(isOnline=Titanium.Network.getOnline()){var t=Ti.Network.createHTTPClient();try{t.onreadystatechange=function(){if(4==t.readyState&&200==t.status){var a=t.responseText;try{var o=JSON.parse(a)}catch(t){alert("NO VALID JSON"),Ti.API.info(e)}pocet=0;try{pocet=o.totalFeatures}catch(e){}var i=1e6;pocet>500&&(i=500,alert("WARNING: too many results, only first 500 will be added to map"));for(var n=0,r="",l=0;l<pocet;l++){var d=0;if("Point"==o.features[0].geometry.type)var s=o.features[l].geometry.coordinates[0],c=o.features[l].geometry.coordinates[1],d=o.features[l].id;else{if("MultiPoint"!=o.features[0].geometry.type){n+=1;break}var s=o.features[l].geometry.coordinates[0][0],c=o.features[l].geometry.coordinates[0][1],d=o.features[l].id;r=r+"'"+d+"', ";var m=o.features[l].properties.plnt_name,u=o.features[l].properties.image,p=o.features[l].properties.imagePathLocal,v=o.features[l].properties.imagePathServer,f=o.features[l].properties.imageDeviceId,h=0;try{h=Date.parse(o.features[l].properties.obs_date)}catch(e){}if(h>0)var w=dateTime(!0,h);else var w="1970-01-01 00:00:00";var b=o.features[l].properties.uid,g=o.features[l].properties.crtn,T=o.features[l].properties.site_conf,E=o.features[l].properties.site_descr;if(l<i){spl=b.split("#");spl[0]}}var I=Ti.Database.open(menoDatabazy);Ti.API.info("AddtoMapButton: SELECT * from annotations WHERE gmlID='"+d+"'");var D=I.execute("SELECT * from annotations WHERE gmlID='"+d+"'");D.rowCount?I.execute("UPDATE annotations SET lat="+c+", lon="+s+", featureType='"+featureTYPE+"', endpointURL='"+endpointURL+"', plnt_name='"+m+"', image='"+u+"', imageDeviceId='"+f+"', imagePathLocal='"+p+"', imagePathServer='"+v+"', obs_date='"+w+"', uid='"+b+"', crtn='"+g+"', site_conf='"+T+"', site_descr='"+E+"', mark_for_del=0, mark_for_push=0 WHERE gmlID='"+d+"' "):(I.execute("INSERT INTO annotations (id, lat, lon, featureType, endpointURL, gmlID, plnt_name, image, imageDeviceId, imagePathLocal, imagePathServer, obs_date, uid, crtn, site_conf, site_descr) VALUES ("+featIdIn+","+c+","+s+", '"+featureTYPE+"', '"+endpointURL+"', '"+d+"', '"+m+"', '"+u+"', '"+f+"', '"+p+"', '"+v+"', '"+w+"','"+b+"', '"+g+"', '"+T+"', '"+E+"' ) "),featIdIn+=1),I.close(),s=null,c=null,d=null,annotationWFS=null,I=null,D=null}try{r=r.substring(0,r.length-2)}catch(e){}""==r&&(r="''");var y="DELETE FROM annotations WHERE gmlID NOT IN(0, "+r+")",I=Ti.Database.open(menoDatabazy);I.execute(y),I.close(),divider(),console.log(y),n>0?alert("CURRENT VERSION SUPPORTS ONLY POINT GEOMETRY TYPES"):buttonLocalDataFunc()}},t.onerror=function(e){alert("Whoops...something is wrong check URL you entered. Error details: "+e.error),console.log(JSON.stringify(e))},t.open("GET",e,!0),t.send()}catch(e){alert("There was network error: "+e)}}else buttonLocalDataFunc()}function buttonLocalDataFunc(e){MapWindowOpen?buttonLocalDataFuncInternal():(MapWindow.open(),readdEventListener(MapWindow,"open",eventListenerMapWindow_fromButton))}function buttonLocalDataFuncInternal(){var e=Ti.Database.open(menoDatabazy),t=e.execute("SELECT * from annotations WHERE mark_for_del=0");for(e.close();t.isValidRow();){var a=(t.fieldByName("gmlID"),t.fieldByName("plnt_name"),t.fieldByName("image"),t.fieldByName("imagePathLocal"),t.fieldByName("imagePathServer"),t.fieldByName("obs_date"),t.fieldByName("uid")),o=a.split("#");o=o[0];var i=(t.fieldByName("crtn"),t.fieldByName("site_conf"),t.fieldByName("site_descr"),"balloon_blue.png");if(a==myNickname)var i="balloon_yellow.png";var n=t.fieldByName("id"),r=i,l=t.fieldByName("lon"),d=t.fieldByName("lat"),s="addAnnotation("+n+","+l+","+d+',"'+r+'");';Ti.App.fireEvent("app:fromTitanium",{message:s}),console.log("========================================================="),console.log(s),console.log("========================================================="),t.next()}Ti.App.fireEvent("app:fromTitanium",{message:"removeAllAnnotations();"})}function eventListenerMainWindow(){var e=Ti.Database.open(menoDatabazy),t=e.execute("SELECT * from annotations WHERE uid='"+myNickname+"' AND (gmlID=0 OR mark_for_push=1 OR mark_for_del=1) ");e.close(),t.rowCount&&drawPushWindow(),drawObservationsToMainWindow(),MainWindow.activity.onCreateOptionsMenu=function(e){var t=MainWindow,a=e.menu,o=Ti.UI.createView({width:100,height:20,backgroundColor:"gray"}),i=a.add({title:"HELP",icon:"/images/drawable-xxhdpi/ic_help_outline_white_24dp.png",showAsAction:Ti.Android.SHOW_AS_ACTION_ALWAYS,order:1}),n=a.add({title:"M",icon:"/images/drawable-xxhdpi/ic_reorder_white_48dp.png",actionView:o,showAsAction:Ti.Android.SHOW_AS_ACTION_ALWAYS|Ti.Android.SHOW_AS_ACTION_COLLAPSE_ACTION_VIEW,order:2});o.addEventListener("click",function(){n.expandedActionView()}),readdEventListener(MainWindow,"click",function(e){try{n.collapseActionView()}catch(e){}}),readdEventListener(n,"expand",function(){Ti.API.info(" -------------> Expanded menu item!");var e=["Local Data","Server Data","Open Map","Support","About"],a=52*e.length;subMenu=Titanium.UI.createView({backgroundColor:"#000000",color:"white",opacity:.9,width:135,height:a,right:0,top:0});var o=new List("",e,function(e){var t=e.itemIndex,a=e.section.items[t].title;e.source;if(0==t&&(activityIndicator.show(),buttonLocalDataFunc()),1==t&&(activityIndicator.show(),buttonRetrieveDatasetsFunc()),2==t&&(activityIndicator.show(),MapWindow.open(),MapWindow.add(webView)),3==t){var o=new Window("Proplant support"),i=Ti.UI.createWebView({left:0,top:0,right:0,bottom:0,width:"100%",height:"100%",borderRadius:1,enableZoomControls:!1,url:"/HTML/acknow/index.html",setWebContentsDebuggingEnabled:!0});o.open(),o.addEventListener("open",function(){o.activity.actionBar.hide()}),o.add(i)}if(4==t){var r=new Window("About Proplant"),l=Ti.UI.createWebView({left:0,top:0,right:0,bottom:0,width:"100%",height:"100%",borderRadius:1,enableZoomControls:!1,url:"/HTML/about/index.html",setWebContentsDebuggingEnabled:!0});r.open(),r.addEventListener("open",function(){r.activity.actionBar.hide()}),r.add(l)}console.log("Klikol si MENU item: "+a.text),n.collapseActionView()},function(e,t){e.title.backgroundColor="white",e.title.color="black",e.title.textAlign=Ti.UI.TEXT_ALIGNMENT_CENTER});subMenu.add(o),t.add(subMenu)}),readdEventListener(n,"collapse",function(){try{t.remove(subMenu)}catch(e){}}),readdEventListener(n,"click",function(){Ti.API.info(" -------------> Click menu item!")}),readdEventListener(i,"click",function(e){var t=new Window("Help",(!1)),a=Ti.UI.createWebView({left:0,top:0,right:0,bottom:0,width:"100%",height:"100%",borderRadius:1,enableZoomControls:!1,url:"/HTML/help/index-home.html",setWebContentsDebuggingEnabled:!0});t.open(),t.add(a)})},MainWindow.activity.invalidateOptionsMenu()}function eventListenerMapWindow(){MapWindowOpen||(MapWindowOpen=!0,MapWindow.activity.onCreateOptionsMenu=function(e){var t=MapWindow,a=e.menu,o=Ti.UI.createView({width:100,height:20,backgroundColor:"gray"}),i=a.add({title:"HELP",icon:"/images/drawable-xxhdpi/ic_help_outline_white_24dp.png",showAsAction:Ti.Android.SHOW_AS_ACTION_ALWAYS,order:1}),n=a.add({title:"MENU",icon:"/images/drawable-xxhdpi/ic_reorder_white_48dp.png",actionView:o,showAsAction:Ti.Android.SHOW_AS_ACTION_ALWAYS|Ti.Android.SHOW_AS_ACTION_COLLAPSE_ACTION_VIEW,order:2});o.addEventListener("click",function(){n.expandedActionView()}),readdEventListener(MapWindow,"click",function(e){try{n.collapseActionView()}catch(e){}}),readdEventListener(n,"expand",function(){Ti.API.info(" -------------> Expanded menu item!");var e=["Locate","Observe","Insert","Capture"],a=52*e.length;subMenu=Titanium.UI.createView({backgroundColor:"#000000",color:"white",opacity:.75,width:135,height:a,right:0,top:0});var o=new List("",e,function(e){var t=e.itemIndex,a=e.section.items[t].title;e.source;0==t&&locate(),1==t&&addGPS(),2==t&&addManually(),3==t&&toggleMapDownloadEnabled(),console.log("Klikol si MENU item: "+a.text),n.collapseActionView()},function(e,t){e.title.backgroundColor="white",e.title.color="black",e.title.textAlign=Ti.UI.TEXT_ALIGNMENT_CENTER});subMenu.add(o),t.add(subMenu)}),readdEventListener(n,"collapse",function(){Ti.API.info(" -------------> Collapsed menu item!");try{t.remove(subMenu)}catch(e){}}),readdEventListener(n,"click",function(){Ti.API.info(" -------------> Click menu item!")}),readdEventListener(i,"click",function(e){var t=new Window("Help",(!1)),a=Ti.UI.createWebView({left:0,top:0,right:0,bottom:0,width:"100%",height:"100%",borderRadius:1,enableZoomControls:!1,url:"/HTML/help/index-map.html",setWebContentsDebuggingEnabled:!0});t.open(),t.add(a)})},MapWindow.activity.invalidateOptionsMenu())}function eventListenerSetMapWindowOpenFalse(){MapWindowOpen=!1,activityIndicator.hide(),manualModEnabled&&addManually()}function eventListenerFromWebView2(e){var t=e.latitude,a=e.longitude;featureType=featureTYPE;var o=default_plnt_name,i="",n=dateTime(!0),r=myNickname;spl=r.split("#");var l=(spl[0],""),d="",s="",c=Ti.Database.open(menoDatabazy);c.execute("INSERT INTO annotations (id, lat, lon, featureType, endpointURL, gmlID, plnt_name, image, obs_date, uid, crtn, site_conf, site_descr) VALUES ("+featIdIn+","+t+","+a+", '"+featureTYPE+"', '"+endpointURL+"', '0', '"+o+"', '"+i+"', '"+n+"','"+r+"', '"+l+"', '"+d+"', '"+s+"' ) "),c.close(),featIdIn+=1,buttonLocalDataFunc();var m="zoomOnGPS("+a+","+t+");";Ti.App.fireEvent("app:fromTitanium",{message:m}),redrawObservations()}function eventListenerFromWebView3(e){var t=e.message;"YES"==t&&(termsOfUse=1,MainWindowScrollView.remove(iconRadioUnchecked),MainWindowScrollView.add(iconRadioChecked),TermsWindow.close()),"NO"==t&&(termsOfUse=0,MainWindowScrollView.remove(iconRadioChecked),MainWindowScrollView.add(iconRadioUnchecked),TermsWindow.close())}function eventListenerFromWebView4(e){currentCenter=e.center,currentZoomLevel=e.zoom,Ti.App.Properties.setString("currentZoomLevel",currentZoomLevel),Ti.App.Properties.setString("currentCenter",currentCenter)}function eventListenerFromWebViewTileLoaded(e){if(mapDownloadEnabled){var t=Titanium.Filesystem;if(t.isExternalStoragePresent())var a=Titanium.Filesystem.externalStorageDirectory;else var a=Titanium.Filesystem.applicationDataDirectory;var o=t.getFile(a),i=(o.getParent().spaceAvailable(),o.nativePath+"/offline/"+e.z);t.getFile(i).isDirectory()||t.getFile(i).createDirectory();var n=o.nativePath+"/offline/"+e.z+"/"+e.x;t.getFile(n).isDirectory()||t.getFile(n).createDirectory();var r=o.nativePath+"/offline/"+e.z+"/"+e.x+"/"+e.y+".png";if(t.getFile(r).isFile());else{var l=Titanium.Network.createHTTPClient({curPath:r,onload:function(e){try{var t=Ti.Filesystem.getFile(e.source.curPath);t.write(this.responseData),t=null}catch(e){console.log(e.message)}},timeout:1e4});l.open("GET",e.url),l.send()}}}function eventListenerwebViewLoad(){if(divider("eventListenerwebViewLoad"),!eventFromButton){var vec=currentCenter;typeof vec!=typeof[]&&(vec=eval("["+vec+"]")),Ti.App.fireEvent("app:fromTitanium",{message:"setCenter(["+vec+"]);setZoom("+currentZoomLevel+");"})}buttonLocalDataFuncInternal()}function eventListenerWebViewZoomButton(){divider(),console.log("============== eventListenerWebViewZoomButton ======================"),console.log("============== ["+zoomTo.lat+", "+zoomTo.lon+"] ======================"),currentCenter=zoomTo.lon+", "+zoomTo.lat,currentZoomLevel<19&&(currentZoomLevel=19),Ti.App.Properties.setString("currentZoomLevel",currentZoomLevel),Ti.App.Properties.setString("currentCenter",currentCenter);var vec=currentCenter;typeof vec!=typeof[]&&(vec=eval("["+vec+"]")),Ti.App.fireEvent("app:fromTitanium",{message:"setCenter(["+vec+"]);setZoom("+currentZoomLevel+");"}),eventFromButton=!1}function eventListenerMapWindow_fromButton(){MapWindowOpen=!0,MapWindow.add(webView)}function eventListMarkForDel(){var e=Ti.Database.open(menoDatabazy);0==currentGML?e.execute("DELETE FROM annotations WHERE id='"+currentFeatIdIn+"'"):e.execute("UPDATE annotations SET mark_for_del='1', mark_for_push=0 WHERE gmlID='"+currentGML+"' "),e.close(),buttonLocalDataFunc()}function eventListenerMapWindowZoomButton(){readdEventListener(webView,"load",eventListenerWebViewZoomButton)}function eventListenerFromWebView(e){Ti.API.warn("**************************************************"),console.log("buttonLocalDataFunc RADEK 848 - FROM WEB VIEW"),Ti.API.warn("**************************************************");var t=Ti.Database.open(menoDatabazy),a=t.execute("SELECT * from annotations WHERE id="+e.message);if(t.close(),a.rowCount){if(currentFeatIdIn=a.fieldByName("id"),myNickname!=a.fieldByName("uid"))var o="View observation: "+a.fieldByName("id"),i=new Window(o,(!1));else var o="Edit observation: "+a.fieldByName("id"),i=new Window(o,(!1),(!0),function(t){if("Save"==t.source.title){currentFeatIdIn=a.fieldByName("id"),currentGML=a.fieldByName("gmlID");var o=Ti.Database.open(menoDatabazy),n="UPDATE annotations SET plnt_name='%1', image='%2', imagePathLocal='%7', imagePathServer='%8', obs_date='%3', crtn='%4', site_conf='%5', site_descr='%6', mark_for_del='0' WHERE id='"+currentFeatIdIn+"'";n=formatString(n,[textFieldPlntName.html,m,textFieldObsDate.value,textFieldCrtn.value,textFieldSiteConf.value,textFieldSiteDescr.value,imagePathLocal,imagePathServer]),o.execute(n),divider(),console.log(n);var n="UPDATE annotations SET mark_for_push='1' WHERE id='"+currentFeatIdIn+"' AND gmlID > 0";o.execute(n),o.close(),1!=e.doNotInvokeMap&&buttonLocalDataFunc(),i.close()}if("Delete"==t.source.title){var r=Ti.UI.createAlertDialog({cancel:1,buttonNames:["Yes","No"],message:"Delete the record?",title:"Deleting ..."});readdEventListener(r,"click",function(e){e.index===e.source.cancel?Ti.API.info("The discard button was clicked"):(currentFeatIdIn=a.fieldByName("id"),currentGML=a.fieldByName("gmlID"),eventListMarkForDel(currentFeatIdIn),i.close(),redrawObservations(),drawPushWindow())}),r.show()}redrawObservationsToMainWindow()});i.backgroundColor="#B9E0AE",i.open(),i.addEventListener("close",function(e){1!=e.doNotInvokeMap&&activityIndicator.hide()});var n=new ScrollView;i.add(n);var r,l=10,d=10,s=95;r=new Label("Plant name: "),r.left=l+140,r.top=d-5,r.height=19,r.right=10,r.width="auto",r.color="#3C4037",r.font.fontWeight="bold",d+=s,d+=40,r=new Label("Site Configuration:"),r.left=l,r.top=d,r.color="#3C4037",n.add(r),d+=s,r=new Label("Observation Date:"),r.left=l,r.top=d,n.add(r),d+=s,r=new Label("Site Description:"),r.left=l,r.top=d,r.color="#3C4037",n.add(r),d+=s,r=new Label("Certainity:"),r.left=l,r.top=d,r.color="#3C4037",n.add(r),d=60,textFieldPlntName=new Label(a.fieldByName("plnt_name")),textFieldPlntName.verticalAlign=Ti.UI.TEXT_ALIGNMENT_TOP,textFieldPlntName.left=l+140,textFieldPlntName.right=10,textFieldPlntName.top=5,textFieldPlntName.height=135,textFieldPlntName.width="auto",textFieldPlntName.verticalAlign=Ti.UI.TEXT_VERTICAL_ALIGNMENT_TOP,n.add(textFieldPlntName),myNickname==a.fieldByName("uid")&&readdEventListener(textFieldPlntName,"click",function(){for(var e="/data/plantlist_latin.json",t=Titanium.Filesystem.getFile(Titanium.Filesystem.resourcesDirectory,e),a=t.read().text,o=JSON.parse(a),i=o.protectedPlants.plant,n=[],r=0;r<i.length;r++){var l=o.protectedPlants.plant[r].latin;n[r]=l}var d=Ti.UI.Android.createSearchView({hintText:"Plant search",backgroundColor:"#000000"}),s=new Window("Latin plant names");s.open(),s.addEventListener("open",function(){s.activity.actionBar.hide()});var c=new List("",n,function(e){s.close(),textFieldPlntName.html=n[e.itemIndex]},function(e,t){e.title.color="#3C4037",e.title.borderColor="#3C4037",e.title.backgroundColor="white",e.title.borderWidth=1,e.title.left="2%",e.title.width="96%",e.title.textAlign=Ti.UI.TEXT_ALIGNMENT_CENTER},d);s.add(c)}),d+=s,d+=35,textFieldSiteConf=new TextField(a.fieldByName("site_conf")),textFieldSiteConf.left=l,textFieldSiteConf.top=d,textFieldSiteConf.setEditable(!1),textFieldSiteConf.backgroundColor="white",myNickname==a.fieldByName("uid")&&readdEventListener(textFieldSiteConf,"click",function(){var e=["in-groups","single plant"],t=new List("",e,function(t){a.close();t.source.selectedIndex;textFieldSiteConf.setValue(e[t.itemIndex])},function(e,t){e.title.color="#3C4037",e.title.borderColor="#3C4037",e.title.backgroundColor="white",e.title.borderWidth=1,e.title.left="2%",e.title.width="96%",e.title.textAlign=Ti.UI.TEXT_ALIGNMENT_CENTER}),a=new Window("Select site configuration: ");a.open(),a.add(t)}),n.add(textFieldSiteConf),imagePathLocal=a.fieldByName("imagePathLocal"),imagePathServer=a.fieldByName("imagePathServer"),imageDefault="/app_ico.png",imageDefault2="/app_ico2.png";var c=imageDefault,m="";if(null!==imagePathServer&&""!=imagePathServer?c=null!==imagePathLocal&&""!=imagePathLocal&&myDeviceId==a.fieldByName("imageDeviceId")?imagePathLocal:imagePathServer:null!==imagePathLocal&&""!=imagePathLocal&&(c=myDeviceId==a.fieldByName("imageDeviceId")?imagePathLocal:imageDefault2),c!=imagePathServer||Titanium.Network.getOnline()||(c=imageDefault2),divider(),console.log(c),c==imageDefault||c==imageDefault2||c==imagePathServer)try{myImage=new ImageCropped(c,130,1)}catch(e){c=imageDefault2,myImage=new ImageCropped(c,130,1)}else{var u=Ti.Filesystem.getFile(c),p=rotateAndResize(u,450,100);console.log(u),myImage=new ImageCropped(p,130,1.25)}myImage.left=l,myImage.top=10,n.add(myImage),myNickname==a.fieldByName("uid")?(myImage.setProps({currentFeatIdIn:a.fieldByName("id"),myImagePath:c}),readdEventListener(myImage,"click",openImagePreview)):(myImage.setProps({currentFeatIdIn:a.fieldByName("id"),myImagePath:c}),readdEventListener(myImage,"click",openImagePreviewReadOnly)),d+=s,textFieldObsDate=new TextField(a.fieldByName("obs_date")),textFieldObsDate.left=l,textFieldObsDate.top=d,textFieldObsDate.setEditable(!1),textFieldObsDate.backgroundColor="white",myNickname==a.fieldByName("uid")&&readdEventListener(textFieldObsDate,"click",function(){new DatePicker(new Date,function(e){var t=0;try{t=Date.parse(e.value)}catch(e){}if(t>0)var a=dateTime(!0,t);else var a=dateTime(!0);textFieldObsDate.setValue(a)})}),n.add(textFieldObsDate),d+=s,textFieldSiteDescr=new TextField(a.fieldByName("site_descr")),textFieldSiteDescr.left=l,textFieldSiteDescr.top=d,textFieldSiteDescr.backgroundColor="white",myNickname!=a.fieldByName("uid")&&textFieldSiteDescr.setEditable(!1),n.add(textFieldSiteDescr),d+=s,textFieldCrtn=new TextField(a.fieldByName("crtn")),textFieldCrtn.left=l,textFieldCrtn.top=d,textFieldCrtn.setEditable(!1),textFieldCrtn.backgroundColor="white",myNickname==a.fieldByName("uid")&&readdEventListener(textFieldCrtn,"click",function(){var e=["high","medium","low","unknown"],t=new List("",e,function(t){a.close();t.source.selectedIndex;textFieldCrtn.setValue(e[t.itemIndex])},function(e,t){e.title.color="#3C4037",e.title.borderColor="#3C4037",e.title.backgroundColor="white",e.title.borderWidth=1,e.title.left="2%",e.title.width="96%",e.title.textAlign=Ti.UI.TEXT_ALIGNMENT_CENTER}),a=new Window("Select certainity: ");a.open(),a.add(t)}),n.add(textFieldCrtn)}}function eventListenerCameraPhotoDone(){new Camera(function(e){fotilSom=!0,imageNativePath=e.media.nativePath,cameraImageName=e.media.file.name,cameraOriginalImage=e.media,cameraRotatedImage=rotateAndResize(cameraOriginalImage,450,100);try{myImage.setImage(cameraRotatedImage),myImage.setProps({myImagePath:imageNativePath})}catch(e){}photoWindowImage.setImage(cameraRotatedImage),myImagePath=imageNativePath,imagePathLocal=imageNativePath;var t=Ti.Database.open(menoDatabazy),a="UPDATE annotations SET image='%1',imageDeviceId='%3', imagePathLocal='%2', imagePathServer='' WHERE id='"+currentFeatIdIn+"'";a=formatString(a,[cameraImageName,imagePathLocal,myDeviceId]),divider("SQL"),console.log(a),t.execute(a),t.close()})}function eventListenerMainWindowScrollViewScrollDo(e){e.source.contentOffset.y!=MainWindowScrollTopLast&&(MainWindowScrollTopLast=e.source.contentOffset.y)}function eventListenerClickPushViewLabelTerms(e){var t=Ti.UI.createWebView({left:0,top:0,right:0,bottom:0,width:"100%",height:"100%",borderRadius:1,enableZoomControls:!1,url:"/HTML/terms/index.html",setWebContentsDebuggingEnabled:!0});TermsWindow.open(),TermsWindow.add(t)}function eventListenerTermsWindowOpen(){TermsWindow.activity.actionBar.hide()}function changeUser(e){var t="http://bolegweb.geof.unizg.hr/proplant/api/login.php",a=Ti.Network.createHTTPClient();try{a.open("GET",t,!0),a.send({user:e})}catch(e){alert(e)}return divider(),console.log("==== PREPARING FOR : STATUS 200 ======"),a.onreadystatechange=function(){if(4==a.readyState&&200==a.status){divider(),console.log("==== STATUS 200 ======");var e=a.responseText;Ti.API.info(e);try{var o=JSON.parse(e);o.error?alert(o.error):(labelUser.text="User: "+o.user+"#"+o.uid,alert("Sucessfully logged in. Your nickname is: "+o.user+"#"+o.uid),myNickname=o.user+"#"+o.uid,Ti.App.Properties.setString("myNickname",myNickname),redrawObservationsToMainWindow(),drawPushWindow(),pushRemoveIfNeeded())}catch(e){alert("NO VALID JSON"),Ti.API.info(t),Ti.API.info(a.responseText)}a.onreadystatechange=null}},a.onerror=function(e){alert("Whoops...something is wrong check URL you entered. Error details: "+e.error)},a}function changeServer(e){return labelServer.text="Server: "+e,endpointURL=e,Ti.App.Properties.setString("endpointURL",e),!0}function fieldSiteDescription(){new AlertInput("Enter the description of the site here: ",function(e){0==e.index&&changeUser(e.source.androidView.value)})}function addGPS(e){Ti.Geolocation.locationServicesEnabled?(Ti.Geolocation.purpose="Get Current Location",Ti.Geolocation.accuracy=Ti.Geolocation.ACCURACY_BEST,Ti.Geolocation.distanceFilter=5,Ti.Geolocation.preferredProvider=Ti.Geolocation.PROVIDER_GPS,Titanium.Geolocation.getCurrentPosition(function(e){if(e.error)Ti.API.error("Error: "+e.error);else{var t=e.coords.latitude,a=e.coords.longitude,o=(e.coords.altitude,e.coords.accuracy,e.coords.speed,e.coords.timestamp,e.coords.altitudeAccuracy,default_plnt_name),i="",n=dateTime(!0),r=myNickname;spl=r.split("#");var l=(spl[0],""),d="",s="",c=Ti.Database.open(menoDatabazy);c.execute("INSERT INTO annotations (id, lat, lon, featureType, endpointURL, gmlID, plnt_name, image, obs_date, uid, crtn, site_conf, site_descr) VALUES ("+featIdIn+","+t+","+a+", '"+featureTYPE+"', '"+endpointURL+"', '0', '"+o+"', '"+i+"', '"+n+"','"+r+"', '"+l+"', '"+d+"', '"+s+"' ) "),
c.close(),featIdIn+=1,buttonLocalDataFunc();var m="zoomOnGPS("+a+","+t+");";Ti.App.fireEvent("app:fromTitanium",{message:m}),redrawObservations()}})):alert("Please enable location services")}function locate(e){Ti.Geolocation.locationServicesEnabled?Titanium.Geolocation.getCurrentPosition(function(e){if(e.error)Ti.API.error("Error: "+e.error);else{Ti.API.info(e.coords.latitude),Ti.API.info(e.coords.longitude);var t=e.coords.latitude,a=e.coords.longitude,o=(e.coords.altitude,"showMyPosition("+a+","+t+");");Ti.App.fireEvent("app:fromTitanium",{message:o})}}):alert("Please enable location services")}function addManually(e){if(1==manualModEnabled){manualModEnabled=0;var t="insertDisable();";Ti.App.fireEvent("app:fromTitanium",{message:t}),MapWindow.remove(insertIconImageView)}else{manualModEnabled=1;var a="insertEnable();";mapDownloadEnabled?insertIconImageView.bottom=25:insertIconImageView.bottom=0,MapWindow.add(insertIconImageView),Ti.App.fireEvent("app:fromTitanium",{message:a})}}function toggleMapDownloadEnabled(){mapDownloadEnabled?(mapDownloadEnabled=!1,MapWindow.remove(mapDownloadOverlay),mapDownloadOverlay=null,1==manualModEnabled&&(insertIconImageView.bottom=0)):(mapDownloadEnabled=!0,mapDownloadOverlay=new Label("Capturing the map - it will be available for offline use"),mapDownloadOverlay.bottom=0,mapDownloadOverlay.left=0,mapDownloadOverlay.right=0,mapDownloadOverlay.height=25,mapDownloadOverlay.backgroundColor="red",mapDownloadOverlay.color="white",mapDownloadOverlay.textAlign=Ti.UI.TEXT_ALIGNMENT_CENTER,mapDownloadOverlay.font={fontSize:12,fontWeight:"bold"},MapWindow.add(mapDownloadOverlay),1==manualModEnabled&&(insertIconImageView.bottom=25))}function rotateAndResize(e,t,a){var o=Ti.Filesystem.getApplicationDataDirectory(),i=String.format("Proplant_%s.jpg",dateTime().replace(" ","_").replace(":","h")+"m"),n=Ti.Filesystem.getFile(o,i),r=n.nativePath;return n.write(e),n=null,utilsModule.rotateResizeImage(r,t||640,a||80),e=Ti.Filesystem.getFile(r)}function readdEventListener(e,t,a){try{e.removeEventListener(t,a)}catch(e){}e.addEventListener(t,a)}function selectedObservationsToBoxes(e,t,a){if(!e.rowCount){var o=0,i=Ti.UI.createView({width:"90%",height:60,left:"5%",top:observationsTop,backgroundColor:"white",borderRadius:5});MainWindowScrollView.add(i),observationObjects[o]=i,observationsTop+=80;var n=Ti.UI.createView({top:0,width:"100%",height:5,backgroundColor:obsColor});i.add(n);var r=new Label(t);r.height=24,r.top=15,r.left=10,r.color="#283618",r.font={fontWeight:"bold"},i.add(r)}for(;e.isValidRow();){var o=e.fieldByName("id"),i=Ti.UI.createView({width:"90%",height:180,left:"5%",top:observationsTop,backgroundColor:"white",borderRadius:5});MainWindowScrollView.add(i),observationObjects[o]=i,observationsTop+=200;var n=Ti.UI.createView({top:0,width:"100%",height:5,backgroundColor:obsColor});i.add(n);var r=new Label("Data collection");r.width=130,r.height=24,r.top=15,r.left=10,r.color="#283618",r.font={fontWeight:"bold"},i.add(r);var l=new Label(e.fieldByName("obs_date"));l.width=180,l.height=24,l.textAlign=Ti.UI.TEXT_ALIGNMENT_RIGHT,l.top=8,l.right=10,l.font={fontSize:11,fontWeight:"bold"},i.add(l);var d=e.fieldByName("crtn");""==d&&(d="no");var s="#DCDCDC";"unknown"==d&&(s="#8D66BF"),"low"==d&&(s="#EFD300"),"medium"==d&&(s="#FFAB52"),"high"==d&&(s="#7CBF66");var c=new Label(d+" certainity");c.width=180,c.height=24,c.textAlign=Ti.UI.TEXT_ALIGNMENT_RIGHT,c.top=20,c.right=10,c.color=s,c.font={fontSize:11,fontWeight:"bold"},i.add(c);var m=new Label("Latitude:    "+e.fieldByName("lat"));m.height=24,m.textAlign=Ti.UI.TEXT_ALIGNMENT_LEFT,m.top=65,m.left=10,m.font={fontSize:16},i.add(m);var u=new Label("Longitude: "+e.fieldByName("lon"));u.height=24,u.textAlign=Ti.UI.TEXT_ALIGNMENT_LEFT,u.top=85,u.left=10,u.font={fontSize:16},i.add(u);var p=new Label(e.fieldByName("plnt_name"),null,10);p.height=19,p.textAlign=Ti.UI.TEXT_ALIGNMENT_LEFT,p.top=40,p.left=10,p.width="95%",p.font={fontSize:14,fonWeight:"bold"},i.add(p);var v=new Image("/images/drawable-xxhdpi/ic_delete_forever_black_48dp.png",function(e){if("new"==a)var t="Delete this new record from local database";if("upd"==a)var t="Do not push this update to server and mark as 'not changed'?";if("del"==a)var t="Cancel removal of this record from database?";var o=Ti.UI.createAlertDialog({cancel:1,buttonNames:["Confirm","Cancel"],message:t,title:"Please confirm"});o.addEventListener("click",function(t){if(t.index===t.source.cancel)Ti.API.info("The cancel button was clicked");else{var o=MainWindowScrollView.children,i=e.source.deleteID,n=Ti.Database.open(menoDatabazy);"new"==a&&n.execute("DELETE FROM annotations WHERE id="+i),"upd"==a&&n.execute("UPDATE annotations SET mark_for_push=0 WHERE id="+i),"del"==a&&n.execute("UPDATE annotations SET mark_for_del=0 WHERE id="+i),n.close();var r="black",l="No new data has been collected",d=!1,s=!1,c=0;for(p=0;p<o.length;p++){if(s){var m=200;d&&(m-=60);var u=Titanium.UI.createAnimation();u.top=o[p].top-m,u.duration=333,o[p].animate(u)}if(o[p]==e.source.getParent()&&(s=!0,c=p,o[c-2].html==labelObservationsNewText||o[c-2].html==labelObservationsUpdText||o[c-2].html==labelObservationsRemText))if(void 0===o[c+1]){d=!0,r="#FF0000";var l="No data has been marked for removal"}else{if(o[c+1].html==labelObservationsUpdText){d=!0,r="#00A20B";var l="No new data has been collected"}if(o[c+1].html==labelObservationsRemText){d=!0,r="#FFD600";var l="No data has been marked for update"}}}if(e.source.getParent().getParent().remove(e.source.getParent()),drawPushWindow(),d){divider(),console.log("This was last child removed !!!");var p=0,v=Ti.UI.createView({width:"90%",height:60,left:"5%",top:o[c].top,backgroundColor:"white",borderRadius:5});MainWindowScrollView.add(v),observationObjects[p]=v,observationsTop+=80;var f=Ti.UI.createView({top:0,width:"100%",height:5,backgroundColor:r});v.add(f);var h=new Label(l);h.height=24,h.top=15,h.left=10,h.color="#283618",h.font={fontWeight:"bold"},v.add(h),pushRemoveIfNeeded()}}}),o.show()});v.deleteID=o,v.width=48,v.height=48,v.bottom=10,v.right=10,i.add(v);var f=new Image("/images/drawable-xxhdpi/ic_language_black_48dp.png",function(e){activityIndicator.show(),buttonLocalDataFunc(e),zoomTo.lat=e.source.lat,zoomTo.lon=e.source.lon,eventFromButton=!0,readdEventListener(MapWindow,"open",eventListenerMapWindowZoomButton)});f.lat=e.fieldByName("lat"),f.lon=e.fieldByName("lon"),f.width=48,f.height=48,f.bottom=10,f.right=68,i.add(f);var h=new Image("/images/drawable-xxhdpi/ic_format_line_spacing_black_48dp.png",function(e){activityIndicator.show();var t={};t.message=e.source.editID,t.doNotInvokeMap=!0,eventListenerFromWebView(t)});h.editID=o,h.width=48,h.height=48,h.bottom=10,h.right=126,i.add(h);var w=new Image("/images/drawable-xxhdpi/ic_image_black_48dp.png",openImagePreview);w.width=48,w.height=48,w.bottom=10,w.right=184,e.next()}}function eventListenerPhotoWindowOpened(){photoWindow.activity.actionBar.hide()}function bytesToHuman(e){var t=1024,a=1024*t,o=1024*a,i=1024*o,n=1024*i,r=1024*n;return e<t?Math.round(e)+" byte":e>=t&&e<a?Math.round(e/t)+" Kb":e>=a&&e<o?Math.round(e/a)+" Mb":e>=o&&e<i?Math.round(e/o)+" Gb":e>=i&&e<n?Math.round(e/i)+" Tb":e>=n&&e<r?Math.round(e/n)+" Pb":e>=r?Math.round(e/r)+" Eb":"???"}function pushRemoveIfNeeded(){var e=Ti.Database.open(menoDatabazy),t=e.execute("SELECT * from annotations WHERE uid='"+myNickname+"' AND (gmlID=0 OR mark_for_push=1 OR mark_for_del=1) ");e.close(),t.rowCount||(pushView.top=-1e3,observationsInitialOffset=0,redrawObservations())}function drawPushWindow(){var e=pushView.children;for(i=0;i<e.length;i++)try{pushView.remove(e[i])}catch(t){console.log(e[i])}pushView.backgroundColor="white",pushView.layout="horizontal",pushView.borderRadius=5,pushView.top=220,pushView.height=340;var t;t=Ti.UI.createView({top:0,left:0,width:"25%",height:5,backgroundColor:"#00A20B"}),pushView.add(t),t=Ti.UI.createView({top:0,left:"25%",width:"25%",height:5,backgroundColor:"#FFD600"}),pushView.add(t),t=Ti.UI.createView({top:0,left:"50%",width:"25%",height:5,backgroundColor:"#FF0000"}),pushView.add(t),t=Ti.UI.createView({top:0,left:"75%",width:"25%",height:5,backgroundColor:"blue"}),pushView.add(t);var a=10,o=new Label("Push data to server");o.top=a,o.left=10,o.right=10,o.height=30,o.font={fontSize:20},pushView.add(o);var n=Ti.Database.open(menoDatabazy),r=n.execute("SELECT * from annotations WHERE uid='"+myNickname+"' AND gmlID=0 ");n.close(),a+=5+o.height;var l=new Label("<font color='#00A20B' size='30'>•</font> "+r.rowCount+" new observations ");l.top=a,l.left=25,l.right=10,l.height=24,l.font={fontSize:16},pushView.add(l);var n=Ti.Database.open(menoDatabazy),r=n.execute("SELECT * from annotations WHERE uid='"+myNickname+"' AND mark_for_push=1 ");n.close(),a+=5+l.height;var d=new Label("<font color='#FFD600' size='30'>•</font> "+r.rowCount+" updated observations ");d.top=a,d.left=25,d.right=10,d.height=24,d.font={fontSize:16},pushView.add(d);var n=Ti.Database.open(menoDatabazy),r=n.execute("SELECT * from annotations WHERE uid='"+myNickname+"' AND mark_for_del=1 ");n.close(),a+=5+d.height;var s=new Label("<font color='#FF0000' size='30'>•</font> "+r.rowCount+" removed observations ");s.top=a,s.left=25,s.right=10,s.height=24,s.font={fontSize:16},pushView.add(s);var n=Ti.Database.open(menoDatabazy),r=n.execute("SELECT * from annotations WHERE uid='"+myNickname+"' AND imageDeviceId='"+myDeviceId+"' AND imagePathLocal!='' AND imagePathLocal!='null' AND (imagePathServer='' OR imagePathServer='null') ");n.close(),a+=5+s.height;var c=new Label("<font color='blue' size='30'>•</font> "+r.rowCount+" photos created ");c.top=a,c.left=25,c.right=10,c.height=24,c.font={fontSize:16},pushView.add(c),a+=5+c.height;var m=new Label("<strong>You agree with our Terms and conditions</strong> (tap to read)");m.top=a,m.left=10,m.right=10,m.height=48,m.font={fontSize:16},pushView.add(m),readdEventListener(m,"click",eventListenerClickPushViewLabelTerms);var u=new Button("Discard all",function(){var e=Ti.UI.createAlertDialog({cancel:1,buttonNames:["Yes","No"],message:"Do you want to discard your edits?",title:"Discarting your edits..."});e.addEventListener("click",function(e){if(e.index===e.source.cancel)Ti.API.info("The discard button was clicked");else{var t=Ti.Database.open(menoDatabazy);t.execute("UPDATE annotations SET mark_for_push = 0, mark_for_del = 0"),t.execute("DELETE from annotations WHERE gmlID= 0"),t.close(),redrawObservations(),pushRemoveIfNeeded()}}),e.show()});u.bottom=65,u.left=10,u.width="45%",u.backgroundColor="#EEEEEE",u.color="#B3B3B3",pushView.add(u);var p=new Button("Push all",function(){var e=Ti.UI.createAlertDialog({cancel:1,buttonNames:["Confirm","Cancel"],message:"Confirm or cancel?",title:"Push all new, edited and/or deleted observations and photos to server?"});e.addEventListener("click",function(e){if(toRefreshMainWindow=0,Ti.API.info("toRefreshMainWindow goes to ZERO"),e.index===e.source.cancel)Ti.API.info("The cancel button was clicked");else{var t=[],a=0,o=Ti.Database.open(menoDatabazy),n=o.execute("SELECT * FROM annotations WHERE mark_for_del=1 AND uid='"+myNickname+"'");for(o.close();n.isValidRow();){spl=n.fieldByName("gmlID").split(".");var r=spl[1];n.fieldByName("id");t.push(r),n.next(),a++,i++}if(a){toRefreshMainWindow++;var l="http://bolegweb.geof.unizg.hr/proplant/api/push_del.php",d=Ti.Network.createHTTPClient();try{d.onreadystatechange=function(){if(4==d.readyState&&200==d.status){var e=d.responseText;Ti.API.info(e);var t=0;try{t=JSON.parse(e),Ti.API.info(JSON.stringify(t))}catch(e){alert("NO VALID JSON (delete)"),Ti.API.info(l),Ti.API.info(d.responseText)}if(0!=t)if("deletedOK"==t){var a=Ti.Database.open(menoDatabazy);a.execute("DELETE FROM annotations WHERE mark_for_del = 1 AND uid='"+myNickname+"'"),a.close(),Ti.API.info("toRefreshMainWindow if is true"),1==toRefreshMainWindow&&(toRefreshMainWindow=0,redrawObservations(),pushRemoveIfNeeded()),toRefreshMainWindow>1&&toRefreshMainWindow--}else alert("You are offline or our server is unreachable, please retry later.");d.onreadystatechange=null}},d.onerror=function(e){alert("You are offline or our server is unreachable, please retry later.")},d.open("POST",l,!0),strTBD=JSON.stringify(t);var s={user:myNickname,tbd:strTBD};d.send(s)}catch(e){divider(),console.log("************ CATCH ON ROW 2540 *****************"),alert(e)}}for(var t=[],a=0,o=Ti.Database.open(menoDatabazy),n=o.execute("SELECT * FROM annotations WHERE mark_for_push=1 AND gmlID!=0 AND uid='"+myNickname+"'");n.isValidRow();){spl=n.fieldByName("gmlID").split(".");var r=spl[1],c=[];for(loopI=0;loopI<n.fieldCount;loopI++)c.push(n.field(loopI));t.push(JSON.stringify(c)),n.next(),a++,i++}if(o.close(),a){toRefreshMainWindow++;var l="http://bolegweb.geof.unizg.hr/proplant/api/push_upd.php",d=Ti.Network.createHTTPClient();try{d.onreadystatechange=function(){if(4==d.readyState&&200==d.status){var e=d.responseText;Ti.API.info(e);var t=0;try{t=JSON.parse(e),Ti.API.info("========================================================"),Ti.API.info(JSON.stringify(t))}catch(e){alert("NO VALID JSON (update)"),Ti.API.info(l),Ti.API.info(d.responseText)}if(0!=t)if("updatedOK"==t){var a=Ti.Database.open(menoDatabazy);a.execute("DELETE FROM annotations WHERE mark_for_push = 1 AND uid='"+myNickname+"'"),a.close(),Ti.API.info("toRefreshMainWindow if is true"),1==toRefreshMainWindow&&(toRefreshMainWindow=0,redrawObservations(),pushRemoveIfNeeded()),toRefreshMainWindow>1&&toRefreshMainWindow--}else alert("You are offline or our server is unreachable, or there was an error during DB update, please retry later, or ocntact app administrator.");d.onreadystatechange=null}},d.onerror=function(e){alert("You are offline or our server is unreachable, please retry later.")},d.open("POST",l,!0),strTBD=JSON.stringify(t);var s={user:myNickname,tbd:strTBD};d.send(s)}catch(e){divider(),console.log("************ CATCH ON ROW 2627 *****************"),alert(e)}}for(var t=[],a=0,o=Ti.Database.open(menoDatabazy),n=o.execute("SELECT * FROM annotations WHERE gmlID=0 AND uid='"+myNickname+"'");n.isValidRow();){spl=n.fieldByName("gmlID").split(".");var r=spl[1],c=[];for(loopI=0;loopI<n.fieldCount;loopI++)c.push(n.field(loopI));Ti.API.info("==================INSERT FIELDS ==========================="),Ti.API.info(JSON.stringify(c)),t.push(JSON.stringify(c)),n.next(),a++,i++}if(o.close(),a){toRefreshMainWindow++;var l="http://bolegweb.geof.unizg.hr/proplant/api/push_ins.php";divider(),console.log("Navigating to URL: "+l),divider(),console.log("== pre-xhr");var d=Ti.Network.createHTTPClient();try{console.log("== pre-onreadystatechange"),d.onreadystatechange=function(){if(console.log("onreadystatechange"),4==d.readyState&&(console.log("xhr.readyState == 4"),200==d.status)){console.log("xhr.status == 200");var e=d.responseText;Ti.API.info(e);var t=0;try{t=JSON.parse(e)}catch(e){alert("NO VALID JSON (insert)"),Ti.API.info("========================================================"),Ti.API.info(l),Ti.API.info(d.responseText)}if(0!=t)if("insertOK"==t){var a=Ti.Database.open(menoDatabazy);a.execute("DELETE FROM annotations WHERE gmlID = 0 AND uid='"+myNickname+"'"),a.close(),Ti.API.info("toRefreshMainWindow if is true"),1==toRefreshMainWindow&&(toRefreshMainWindow=0,redrawObservations(),pushRemoveIfNeeded()),toRefreshMainWindow>1&&toRefreshMainWindow--}else alert("You are either offline or our server is unreachable, or there was an error during DB update, please retry later, or contact app administrator.");d.onreadystatechange=null}},console.log("== pre-onerror"),d.onerror=function(e){alert("You are offline or our server is unreachable, please retry later.")},console.log("== pre-open"),d.open("POST",l,!0),strTBD=JSON.stringify(t);var s={user:myNickname,tbd:strTBD};console.log("== pre-send"),d.send(s)}catch(e){divider(),console.log("************ CATCH ON ROW 2727 *****************"),console.log(e),alert(e)}}pushOneImage()}}),e.show()});p.bottom=65,p.right=10,p.width="45%",p.backgroundColor="#00A20B",pushView.add(p);var v=new Label("<cite>* you may review your data below this box before uploading.</cite>");v.bottom=10,v.left=10,v.right=10,v.height=48,v.font={fontSize:16},pushView.add(v),observationsInitialOffset=pushView.height}function openImagePreview(e){divider("openImagePreview"),console.log(e),photoWindow=new Window("Image preview"),photoWindow.open();try{photoWindowImage=new Image(rotateAndResize(Ti.Filesystem.getFile(e.source.myProps.myImagePath),photoWindow.width,100))}catch(t){photoWindowImage=new Image(e.source.myProps.myImagePath,photoWindow.width,100)}photoWindowImage.top=0,photoWindowImage.width="100%",photoWindow.add(photoWindowImage);var t=new Button(" ",eventListenerCameraPhotoDone);t.backgroundImage="/images/drawable-xxhdpi/ic_photo_camera_black_48dp.png",t.bottom=10,t.width=64,t.height=64,t.backgroundColor="white",photoWindow.add(t),readdEventListener(photoWindow,"open",eventListenerPhotoWindowOpened)}function openImagePreviewReadOnly(e){divider("openImagePreview"),console.log(e),photoWindow=new Window("Image preview"),photoWindow.open();try{photoWindowImage=new Image(rotateAndResize(Ti.Filesystem.getFile(e.source.myProps.myImagePath),photoWindow.width,100))}catch(t){photoWindowImage=new Image(e.source.myProps.myImagePath,photoWindow.width,100)}photoWindowImage.top=0,photoWindowImage.width="100%",photoWindow.add(photoWindowImage),readdEventListener(photoWindow,"open",eventListenerPhotoWindowOpened)}var menoDatabazy="db",osname=Ti.Platform.osname,version=Ti.Platform.version,height=Ti.Platform.displayCaps.platformHeight,width=Ti.Platform.displayCaps.platformWidth,apiLevel=Ti.Platform.Android.API_LEVEL,isAndroid="android"===Ti.Platform.osname,isOnline=Titanium.Network.getOnline(),utilsModule=require("com.tokenbros.utils"),html2as=require("nl.fokkezb.html2as"),Window=require("ui/window"),Button=require("ui/button"),Map=require("ui/map"),List=require("ui/list"),Image=require("ui/image"),ImageCropped=require("ui/imageCropped"),DatePicker=require("ui/datepicker"),Camera=require("ui/camera"),Label=require("ui/label"),TextField=require("ui/textfield"),ScrollView=require("ui/scrollview"),AlertInput=require("ui/alertinput"),myDeviceId=Ti.App.Properties.getString("myDeviceId",Ti.Platform.getId()),myNickname=Ti.App.Properties.getString("myNickname","DEMO#0"),currentZoomLevel=Ti.App.Properties.getString("currentZoomLevel",3),currentCenter=Ti.App.Properties.getString("currentCenter","[19.5, 48.7]"),endpointURL="http://bolegweb.geof.unizg.hr/geoserver/proplant/ows",featureTYPE="proplant:obs_all",databuttonRetrieveDatasets,databuttonRetrieveDatasetsLocal,featIdIn=1,manualModEnabled=0,currentGML,currentFeatIdIn,imageNativePath,termsOfUse,default_plnt_name="Plant name not defined",obsColor,labelObservationsNew,observationsTop,labelObservationsNewBox,observationObjects,labelObservationsUpdated,labelObservationsUpdBox,labelObservationsRemoved,labelObservationsDelBox,observationsInitialOffset=0,noDataTextNew="No new data has been collected",noDataTextUpd="No data has been marked for update",noDataTextRem="No data has been marked for removal",labelObservationsNewText="New observations",labelObservationsUpdText="Updated observations",labelObservationsRemText="Removed observations",db=Ti.Database.open(menoDatabazy);db.execute("CREATE TABLE IF NOT EXISTS annotations (id INTEGER PRIMARY KEY,lat DECIMAL (15,7) NOT NULL,lon DECIMAL (15,7) NOT NULL,acc DECIMAL (10,4),alt DECIMAL (10,4),ala DECIMAL (10,4),type varchar(255),gmlID varchar(255),featureType varchar(255),endpointURL varchar(255),plnt_name varchar(255),image varchar(255) default '',imageDeviceId varchar(255) default '',imagePathLocal varchar(255) default '',imagePathServer varchar(255) default '',obs_date varchar(255),uid varchar(255),crtn varchar(255),site_conf varchar(255),site_descr varchar(255),mark_for_push integer(1) default 0,mark_for_del integer(1) default 0);    "),db.execute("CREATE TABLE IF NOT EXISTS featureTypes (featureType varchar(255),endpointURL varchar(255));    ");for(var select=db.execute("SELECT * from annotations ORDER BY id DESC LIMIT 1");select.isValidRow();)featIdIn=1+select.fieldByName("id"),select.next();db.close();var toRefreshMainWindow=0,MainWindow=new Window("Proplant monitor",(!0));MainWindow.open();var MapWindow=new Window("Map"),MapWindowOpen=!1,zoomTo={lat:10,lon:10},webView=Ti.UI.createWebView({left:0,top:0,right:0,bottom:0,width:"100%",height:"100%",borderRadius:15,enableZoomControls:!1,url:"/HTML/openlayers/index.html",setWebContentsDebuggingEnabled:!0}),MainWindowScrollTopLast=0,MainWindowScrollView=new ScrollView;MainWindow.add(MainWindowScrollView);var pushView=Ti.UI.createView({width:"90%",height:60,left:"5%",top:observationsTop,backgroundColor:"red",top:-1e3});MainWindowScrollView.add(pushView);var insertIconImageView=new Label("Manual insert mode active - touch map to insert marker");insertIconImageView.bottom=0,insertIconImageView.left=0,insertIconImageView.right=0,insertIconImageView.height=25,insertIconImageView.backgroundColor="#5B6F55",insertIconImageView.color="white",insertIconImageView.textAlign=Ti.UI.TEXT_ALIGNMENT_CENTER,insertIconImageView.font={fontSize:12,fontWeight:"bold"};var mapDownloadEnabled=!1,mapDownloadOverlay=null;html2as('<font size="25" face="Arial">Welcome to the\n<b>Proplant Monitor</b> App</font>',function(e,t){if(e)console.error(e);else{var a=new Label;a.attributedString=t,a.top=20,a.textAlign=Ti.UI.TEXT_ALIGNMENT_CENTER,a.font={fontSize:22},a.width="75%",a.height=65,MainWindowScrollView.add(a)}});var labelUser=new Label("User: "+myNickname);labelUser.top=90,labelUser.textAlign=Ti.UI.TEXT_ALIGNMENT_CENTER,labelUser.font={fontSize:20},MainWindowScrollView.add(labelUser);var buttonUser=new Button("Change user",buttonUserClick);buttonUser.top=140,MainWindowScrollView.add(buttonUser);var TermsWindow=new Window("Terms of use for data"),progressIndicator=Ti.UI.Android.createProgressIndicator({message:"In progress...",location:Ti.UI.Android.PROGRESS_INDICATOR_DIALOG,type:Ti.UI.Android.PROGRESS_INDICATOR_DETERMINANT,cancelable:!1,min:0,max:100}),activityIndicator=Ti.UI.Android.createProgressIndicator({message:"Please wait...",location:Ti.UI.Android.PROGRESS_INDICATOR_DIALOG,type:Ti.UI.Android.PROGRESS_INDICATOR_INDETERMINANT,cancelable:!1});MainWindow.add(activityIndicator),readdEventListener(MainWindow,"open",eventListenerMainWindow),readdEventListener(MainWindowScrollView,"scroll",eventListenerMainWindowScrollViewScrollDo),readdEventListener(MapWindow,"open",eventListenerMapWindow),readdEventListener(MapWindow,"close",eventListenerSetMapWindowOpenFalse),readdEventListener(Ti.App,"app:fromWebView",eventListenerFromWebView),readdEventListener(Ti.App,"app:fromWebView2",eventListenerFromWebView2),readdEventListener(Ti.App,"app:fromWebView3",eventListenerFromWebView3),readdEventListener(Ti.App,"app:fromWebView4",eventListenerFromWebView4),readdEventListener(Ti.App,"app:fromWebViewTileLoaded",eventListenerFromWebViewTileLoaded),readdEventListener(TermsWindow,"open",eventListenerTermsWindowOpen),readdEventListener(webView,"load",eventListenerwebViewLoad),readdEventListener(Titanium.Geolocation,"location",eventListenerTiGeolocation);var eventFromButton=!1,imagePathLocal,imagePathServer,imageDefault,textFieldPlntName,textFieldSiteConf,textFieldObsDate,textFieldSiteDescr,textFieldCrtn,myImage;Ti.Geolocation.Android.manualMode=!0,gpsProvider=Ti.Geolocation.Android.createLocationProvider({name:Ti.Geolocation.PROVIDER_GPS,minUpdateTime:10,minUpdateDistance:1}),Ti.Geolocation.Android.addLocationProvider(gpsProvider),netProvider=Ti.Geolocation.Android.createLocationProvider({name:Ti.Geolocation.PROVIDER_NETWORK,minUpdateTime:10,minUpdateDistance:1}),Ti.Geolocation.Android.addLocationProvider(netProvider);var gpsRule=Ti.Geolocation.Android.createLocationRule({provider:Ti.Geolocation.PROVIDER_GPS,accuracy:100,maxAge:6e4,minAge:1e3});Ti.Geolocation.Android.addLocationRule(gpsRule);var netRule=Ti.Geolocation.Android.createLocationRule({provider:Ti.Geolocation.PROVIDER_NETWORK,accuracy:100,maxAge:6e4,minAge:1e3});Ti.Geolocation.Android.addLocationRule(netRule);var photoWindowImage;